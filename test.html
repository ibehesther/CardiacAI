<!DOCTYPE html>
<html>
	<head>
		<title>CardiacAI Hotspot Setup</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
		/>
		<style>
			body {
				font-family: Arial, sans-serif;
				background-color: #f0f0f0;
				margin: 0;
				padding: 20px;
			}
			.container {
				background-color: #fff;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				max-width: 400px;
				margin: 20px auto;
			}
			h2 {
				color: #333;
				text-align: center;
			}
			label {
				display: block;
				margin-bottom: 5px;
				color: #555;
			}
			.ssid,
			.password-container {
				width: calc(100% - 22px);
				padding: 10px;
				margin-bottom: 15px;
				border: 1px solid #ddd;
				border-radius: 4px;
			}

			.password-container {
				padding: 0 0;
				width: 100%;
			}
			.password-focus {
				border: 2px solid #007bff;
			}
			.hidden {
				display: none;
			}
			#password {
				border: 0;
				padding: 10px;
				width: 85%;
				height: 100%;
			}
			#password:focus-visible {
				outline: 0;
			}
			button {
				background-color: #007bff;
				color: white;
				padding: 10px 15px;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				width: 100%;
				font-size: 16px;
			}
			button:hover {
				background-color: #0056b3;
			}
			p {
				text-align: center;
				color: #666;
				font-size: 0.9em;
			}
			.status {
				text-align: center;
				margin-top: 15px;
				font-weight: bold;
			}
			#networksList {
				list-style: none;
				padding: 0;
				margin-top: 15px;
				border-top: 1px solid #eee;
			}
			#networksList li {
				padding: 8px 0;
				border-bottom: 1px solid #eee;
				cursor: pointer;
			}
			#networksList li:hover {
				background-color: #f9f9f9;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h2>CardiacAI WiFi Setup</h2>
			<form id="wifiForm">
				<label for="ssid">WiFi SSID:</label>
				<input
					type="text"
					class="ssid"
					id="ssid"
					name="ssid"
					tabindex="0"
					required
				/><br />
				<label for="password">WiFi Password:</label>
				<div class="password-container" tabindex="0">
					<input type="password" id="password" name="password" required /><i
						id="show-password"
						class="fa fa-eye icon"
					></i>
					<i id="hide-password" class="fa fa-eye-slash icon hidden"></i>
				</div>
				<br />
				<button type="submit">Save & Connect</button>
			</form>
			<p class="status" id="responseStatus"></p>

			<hr />
			<h3>Available WiFi Networks</h3>
			<button id="scanButton">Scan Networks</button>
			<p id="scanStatus"></p>
			<ul id="networksList"></ul>
		</div>
		<script>
			const showPassword = document.getElementById("show-password");
			const hidePassword = document.getElementById("hide-password");
			const passwordContainer = document.querySelector(".password-container");
			document
				.getElementById("wifiForm")
				.addEventListener("submit", async function (event) {
					event.preventDefault(); // Prevent default form submission
					const ssid = document.getElementById("ssid").value;
					const password = document.getElementById("password").value;
					const responseStatus = document.getElementById("responseStatus");

					responseStatus.textContent = "Saving...";
					responseStatus.style.color = "orange";

					try {
						// Send credentials as JSON to the /setupWifi endpoint
						const response = await fetch("/setupWifi", {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({ ssid: ssid, password: password }),
						});
						const data = await response.json(); // Parse the JSON response from the server

						if (response.ok) {
							// Check if the HTTP status code is 2xx (success)
							responseStatus.textContent =
								data.message || "Credentials saved! Connecting to WiFi...";
							responseStatus.style.color = "green";
							// You might want to automatically redirect the user or provide further instructions here
						} else {
							responseStatus.textContent =
								data.error || "Failed to save credentials.";
							responseStatus.style.color = "red";
						}
					} catch (error) {
						console.error("Error:", error); // Log any network or fetch errors
						responseStatus.textContent = "Network error. Try again.";
						responseStatus.style.color = "red";
					}
				});

			document
				.getElementById("scanButton")
				.addEventListener("click", async function () {
					const networksList = document.getElementById("networksList");
					const scanStatus = document.getElementById("scanStatus");
					scanStatus.textContent = "Scanning...";
					networksList.innerHTML = ""; // Clear previous list

					try {
						const response = await fetch("/scanNetworks");
						const networks = await response.json();

						if (networks.length === 0) {
							scanStatus.textContent = "No networks found.";
						} else {
							scanStatus.textContent = `Found ${networks.length} networks:`;
							networks.forEach((net) => {
								const li = document.createElement("li");
								li.textContent = `${net.ssid} (RSSI: ${net.rssi})`;
								li.dataset.ssid = net.ssid; // Store SSID in data attribute
								li.addEventListener("click", function () {
									document.getElementById("ssid").value = this.dataset.ssid;
								});
								networksList.appendChild(li);
							});
						}
					} catch (error) {
						console.error("Error scanning networks:", error);
						scanStatus.textContent = "Error scanning networks.";
					}
				});

			// Optional: Trigger a scan on page load
			document.addEventListener("DOMContentLoaded", function () {
				document.getElementById("scanButton").click();
			});
			passwordContainer.addEventListener("click", (e) => {
				document.getElementById("password").focus();

				passwordContainer.classList.add("password-focus");
			});

			document.getElementById("password").addEventListener("blur", () => {
				passwordContainer.classList.remove("password-focus");
			});

			showPassword.addEventListener("click", () => {
				hidePassword.classList.remove("hidden");
				showPassword.classList.add("hidden");

				document.getElementById("password").type = "text";
			});

			hidePassword.addEventListener("click", () => {
				showPassword.classList.remove("hidden");
				hidePassword.classList.add("hidden");

				document.getElementById("password").type = "password";
			});
		</script>
	</body>
</html>
